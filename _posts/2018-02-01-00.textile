---
layout:     post
title:      "Трюки и хаки при экспериментах с IPCam от Xiong Mai"
tagline:    ""
category:   ""
group:      ipcam
tags:       [hi3518e, ipcam, zftlab]
---


h3. Введение

p. Материал в стадии оформления. Последнее обновление - 2018.04.13

p{color:red}. Используя данный Сайт, Вы выражаете свое согласие с "«Отказом от ответственности»":/disclaimer.html и принимаете всю ответственность за выполняемые действия с оборудованием и программным обеспечением на себя !

p{color:blue}. Просьба - при использовании материалов с сайта в своих проектах, указывать первоисточник. Спасибо!

p{color:green}. Доступ в группу для различных обсуждений по IPCam и NVR возможен через "WebIRC":http://chat.forestnet.org/?channels=ipcam = "Slack":https://flymon.slack.com/messages/C90NVG1HA/ = "Telegram":http://t.me/joinchat/FhtyHxDpQsv8HlRliQDgqw

---

h3. Благодарности

p. Данная информация является результатом совместной работы дружной компании:

* "ESonya":http://www.cctvsp.ru/ - Игорь, г.Сергиев Посад
* "FlyRouter":http://zftlab.org - Игорь, г.Симферополь
* "max380":/ - Максим, г.Екатеринбург
* "Oleg34":https://vk.com/id379460034 - Олег, г.Волгоград
* и много других товарищей...

---

h3. Создание полного дампа с Flash устройства (ff, fullflash)

p{color:red}. СТРОГО РЕКОМЕНДУЕТСЯ СДЕЛАТЬ ДАННУЮ МАНИПУЛЯЦИЮ ПЕРЕД ЛЮБЫМИ ЭКСПЕРИМЕНТАМИ !

p. Настройте TFTP сервер и проверьте доступ к нему

p. Выполните в консоли, нажав Ctrl+C для остановки загрузки ядра после подачи питания на модуль

p. Ниже приведен пример создания дампа для 8Mb Flash

pre. #
set serverip 192.168.1.254                     // Устанавка адреса TFTP сервера
sf probe 0                                     // Разрешение доступа к флешке
sf read 0x82000000 0x0 0x800000                // Чтение всей флешки в память
tftp 0x82000000 ff.img 0x800000                // Выгрузка дампа (fullflash) на TFTP сервер

p. Практический пример бекапа 8Mb Flash одной строкой

pre. set serverip 192.168.1.254; sf probe 0; sf read 0x82000000 0x0 0x800000; tftp 0x82000000 ff.img 0x800000

p. Ниже приведен пример создания дампа для 16Mb Flash

pre. #
set serverip 192.168.1.254                     // Устанавка адреса TFTP сервера
sf probe 0                                     // Разрешение доступа к флешке
sf read 0x82000000 0x0 0x1000000               // Чтение всей флешки в память
tftp 0x82000000 ff.img 0x1000000               // Выгрузка дампа (fullflash) на TFTP сервер

p. Практический пример бекапа IP камеры JVT 323

pre. set ipaddr 192.168.1.10; set serverip 192.168.1.254
sf probe 0; sf read 0x82000000 0x0 0x1000000; tftp 0x82000000 ff.img 0x1000000

p. Вариант снятия дампа на USB флешку (если есть порт и поддерживает загрузчик)

pre. usb start
sf probe 0; sf read 0x82000000 0x0 0x1000000; fatload usb 0:1 0x82000000 dump.bin


---


h3. Откат на стоковую заводскую прошивку

p. Периодически на распродажах Aliexpress попадаются IP камеры с вшитыми в них OEM прошивками, заточенными только под китайский сегмент. Попытка перепрошить такую камеру стандартными способамм не приносят должного результата.

p. Как правило, в программах CMS или Upgrade Tool такие камеры содержат перед Hardware ID цифры, вместо нулей. Например, обычная камера имеет HW ID 00022520, а вот заблокированная или заточенная под какой-то сервис будет выглядеть как 3422520.

p. Для решения данной проблемы, подберите свежую стоковую прошивку для вашего типа камеры, распакуйте её в каталог TFTP сервера, подключите UART консоль, войдите в загрузчик и выполните команды, приведенные ниже.

pre. setenv serverip 192.168.1.254; sf probe 0; sf lock 0; run dc; run dr; run du; run dw; reset

p. После прошивки, камера перезагрузится и будет доступна уже с пустым префиксом (нули) перед HW ID. Так как в целях защиты от "дурака" консольной командой выше загрузчик НЕ обновляется, то для его замены желательно повторно обновить прошивку уже стандартными средствами.


---


h3. Обновление из полного дампа устройства (ff, fullflash) через консоль

p. Настройте TFTP сервер и положите на него фаил дампа ff.img

p. Важно !  В результате вы получите полный дубликат устройства с которого сняли дамп !

p. Выполните в консоли, нажав Ctrl+C для остановки загрузки ядра после подачи питания на модуль

p. Ниже приведен пример обновление из полного дампа для 8Mb Flash

pre. #
set serverip 192.168.1.254                     // Устанавка адреса TFTP сервера
sf probe 0                                     // Разрешение доступа к флешке
tftp 0x82000000 ff.img                         // Загрузка в память дампа (fullflash)
sf erase 0x000000000000 0x800000               // Очистка всей флешки под запись
sf write 0x82000000 0x000000000000 0x800000    // Запись дампа (fullflash) из памяти на флешку
reset                                          // Рестарт устройства

p. Ниже приведен пример обновление из полного дампа для 16Mb Flash

pre. #
set serverip 192.168.1.254                     // Устанавка адреса TFTP сервера
sf probe 0                                     // Разрешение доступа к флешке
tftp 0x82000000 ff.img                         // Загрузка в память дампа (fullflash)
sf erase 0x000000000000 0x1000000              // Очистка всей флешки под запись
sf write 0x82000000 0x000000000000 0x1000000   // Запись дампа (fullflash) из памяти на флешку
reset                                          // Рестарт устройства

---

h3. Обновление загрузчика (u-boot bootloader) через консоль

p. Настройте TFTP сервер и положите на него фаил u-boot.bin

p. Важно !  Всегда проверяйте первый байт загрузчика что-бы не получить "кирпич" !

p. Важно !  Крипто-раздел, прикреплённый к загрузчику в данном примере будет уничтожен !

p. Выполните в консоли, нажав Ctrl+C для остановки загрузки ядра после подачи питания на модуль

pre. #
mw.b 0x82000000 0xFF 0x40000                   // Очистка памяти под запись
set serverip 192.168.1.254                     // Устанавка адреса TFTP сервера
tftp 0x82000000 u-boot.bin                     // Загрузка в память загрузчика
sf probe 0                                     // Разрешение доступа к флешке
sf erase 0 0x40000                             // Очистка части флешки под запись
sf write 0x82000000 0 0x40000                  // Запись загрузчика из памяти на флешку
reset                                          // Рестарт устройства

---

h3. Пример прошивки устройств с USB флешки

pre. #
usb start
fatload usb 0:1 0x82000000 dump.bin
sf probe 0
sf lock 0
sf erase 0 0x1000000
sf write 0x82000000 0 0x1000000

---

h3. Включение отображения процесса загрузки ядра Linux

p. Иногда возникает необходимость, при поиске проблем, отобразить ход загрузки ядра и модулей.

p. Включение режима возможно в самом Linux, если зайти на устройство по Telnet.

pre. #
armbenv -s xmuart 0                            // Включение отображения загрузки ядра Linux
reboot                                         // Рестарт устройства

---

h3. Изменение некоторых системных параметров

p. Команда armbenv позволяет изменять некоторые настройки системы, работая с ENV областью загрузчика.

p. Все переменные можно изменять как непосредственно в Linux, так и в самом загрузчике.

p. Так, например, выполнение *appauto 0* позволяет отключить проверку работы и наличия Sofia в системе.

p. А выполнение *setenv telnetctrl 1; saveenv* попытается включить Telnet сервер.

p. Список переменных можно запросить командой *armbenv -r*. Ниже представлен пример выполнения команды.

pre. #
bootdelay = 1
baudrate = 115200
serverip = 192.168.1.1
ipaddr = 192.168.1.10
netmask = 255.255.255.0
ethaddr = 00:12:21:10:a3:d5
xmuart = 0
xmauto = 0                                     // Watchdog для перезагрузки камеры
telnetctrl = 1
NID = 0x0003

---

h3. Очистка MTD раздела на Flash камеры (сброс настроек)

p{color:red}. ВЫ ДОЛЖНЫ ОТДАВАТЬ СЕБЕ ОТЧЁТ О ПРОДЕЛЫВАЕМЫХ ОПЕРАЦИЯХ !

p. Для вычисления адреса и размера стираемого раздела необходимо смотреть MTD partitions.

p. Выполните в консоли, нажав Ctrl+C для остановки загрузки ядра после подачи питания на модуль.

|=. ID камеры  |=. Адрес и размер для чистки                  |
|=. 06510      |=. sf probe 0; sf erase 0x0000007b0000 50000  |
|=. 18510      |=. sf probe 0; sf erase 0x0000007b0000 50000  |
|=. 18520      |=. sf probe 0; sf erase 0x0000007b0000 50000  |

---

h3. Получение базовой информации по плате XM

p. Для получения базовой информации по плате XM выполните команду *dvrbox* в консоли

pre. # dvrbox
LibCrypto : g_cryptotype = 1
00:12:16:d8:6f:89
*************************************************
|                      SYSTEM INFO
|                 ID:           8043421804748432
|       product type:           53H13
|            product:           HI3518E_53H13_S39
|      video channel:           1
|      audio channel:           1
|           alarm in:           1
|          alarm out:           1
| forward video chip:           AR0130
|           DSP chip:           HI3518E
|  analog audio mode:           voice codec
|           talkback:           voice codec
|    back video chip:           no chip
|    store interface:           SDIO
|    matrix surpport:           No
| wireless interface:           USB
|    hardware encode:           encode chip
|   hardware version:           1
|    video_interface:           BNC
|      net_interface:           Ethernet
|  hardware info len:           8
*************************************************
LIBDVR: Complied at Sep 12 2016 10:37:43 SVN:1579

---

h3. Типовые полезные команды

p. Сканирование локальной сети для поиска видеокамер

pre. clear; nmap -p 23,80,554 192.168.1.1-254

p. Запуск Telnet сервера на камере без авторизации

pre. telnetd -F -p 4321 -l /bin/ash

---

h3. Внутренние ссылки

<ul>
  {% assign pages_list = site.posts %}
  {% assign group = 'ipcam' %}
  {% include JB/pages_list %}
</ul>

---

h3. Внешние ссылки

* -
